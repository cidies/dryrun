{% extends 'base.html' %}

{% block content %}
<h2>Inject Bearbeiten</h2>
<form id="edit-inject-form" action="{{ url_for('edit_inject', inject_id=inject.id) }}" method="post" style="display: flex; flex-direction: column; align-items: start; overflow: auto; height: 80vh;">

    <input type="hidden" id="edit-inject-id" value="{{ inject.id }}">

    <label for="edit-title">Titel:</label>
    <input type="text" id="edit-title" value="{{ inject.title }}" style="margin-bottom: 10px;">

    <div style="display: flex; justify-content: space-between;">
        <div style="flex: 1; margin-right: 10px;">
            <label for="edit-description">Beschreibung:</label>
            <textarea id="edit-description" style="height: 100px; width: 100%; margin-bottom: 10px;">{{ inject.description }}</textarea>
        </div>
    
        <div style="flex: 1; margin-left: 10px;">
            <label for="edit-exercise-benefit">Übungsnutzen:</label>
            <textarea id="edit-exercise-benefit" style="height: 100px; width: 100%; margin-bottom: 10px;">{{ inject.exercise_benefit }}</textarea>
        </div>
    </div>
    <label for="edit-expected-response">Erwarteter Umgang:</label>
    <textarea id="edit-expected-response" style="height: 100px; width: 300px; margin-bottom: 10px;">{{ inject.expected_response }}</textarea>

    <label for="edit-assigned-scenarios">Zugewiesene Szenarien:</label>
    <select id="edit-assigned-scenarios" name="scenarios" multiple>
        {% for scenario in scenarios %}
            <option value="{{ scenario.id }}" {% if scenario.id|string in inject.assigned_scenarios %}selected{% endif %}>{{ scenario.name }} (ID: {{ scenario.id }})</option>
        {% endfor %}
    </select>
    

    <!-- 
        <input type="text" id="edit-assigned-scenarios" value="{{ inject.assigned_scenarios }}" style="margin-bottom: 10px;"> 
    -->

    <label for="edit-communication_type">Kommunikationsart:</label>
    <select id="edit-communication_type" style="margin-bottom: 10px;">
        <option value="email" {% if inject.communication_type == 'email' %}selected{% endif %}>Email</option>
        <option value="text" {% if inject.communication_type == 'text' %}selected{% endif %}>Text</option>
        <option value="call" {% if inject.communication_type == 'call' %}selected{% endif %}>Anruf</option>
        <option value="personally" {% if inject.communication_type == 'personally' %}selected{% endif %}>Persönlich</option>
    </select>

    <button type="submit">Speichern</button>
</form>
<p>Assigned Scenarios: {{ inject.assigned_scenarios }}</p>
<br><hr>
<p>Scenarios: {{ scenarios }}</p>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
$(window).on('load', function() {
    $('#edit-inject-form').on('submit', function(e) {
        e.preventDefault();
        console.log('Formular abgesendet');

        var assigned_scenarios = $('#edit-assigned-scenarios option:selected').map(function() {
            console.log('Option value:', this.value);
            if (this.value) {
                return this.value;
            }
        }).get().filter(Boolean);
        console.log('Assigned Scenarios:',assigned_scenarios);

        var data = {
            id: $('#edit-inject-id').val(),
            title: $('#edit-title').val(),
            description: $('#edit-description').val(),
            exercise_benefit: $('#edit-exercise-benefit').val(),
            expected_response: $('#edit-expected-response').val(),
            communication_type: $('#edit-communication_type').val(),
            assigned_scenarios: assigned_scenarios
        };

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                // Dieser Code wird ausgeführt, wenn der Server eine erfolgreiche Antwort sendet
                alert('Daten erfolgreich gespeichert!');
            },
            error: function(jqXHR, textStatus, errorThrown) {
                // Dieser Code wird ausgeführt, wenn der Server einen Fehler zurückgibt
                alert('Ein Fehler ist aufgetreten: ' + textStatus);
            }
        });
    });
});
</script>
{% endblock %}